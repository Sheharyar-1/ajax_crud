<p style="color: green"><%= notice %></p>

<% content_for :title, "Users" %>
<div class= "Container">
  <div class="row" >
    <div class="col-lg-10 mx-md-auto">
      <h1>Users</h1>
        <%= link_to "New user", new_user_path, remote: true, class: "btn btn-primary btn-lgs mb-4", data: { bs_toggle: "modal", bs_target: "#newUserModal", loacl: false } %>

        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Contact</th>
              <th colspan="3"></th>
            </tr>
          </thead>

          <tbody>
            <% @users.each do |user| %>
              <tr id="user-row-<%= user.id%>">
                <td>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input user-select-check" 
                    id="user_<%=user.id%>" data-user-id="<%= user.id%>">
                    <label class="form-check-label" for="user_<%=user.id%>"></label>
                  </div>
                </td>  
                <td><%= user.name%></td>
                <td><%= user.email%></td>
                <td><%= user.contact%></td>
                <td><%= link_to 'Show',user %></td>
                <td><%= link_to 'Edit',edit_user_path(user) %></td>
                <td><%= link_to 'Destroy',user, method: :delete, data: {confirm: 'Are you sure?'}%>
              </tr>
            <%end%>
          </tbody>
        </table>
        <button type="button" class="btn btn-danger" id="delete-users" style="display: none;">Delete Users</button>
      </div>

    </div>
  </div>
</div>
      



<!-- Modal -->
<div class="modal fade" id="newUserModal" tabindex="-1" role="dialog" aria-labelledby="newUserModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newUserModal">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="newUserForm">
        ...
      </div>
      
    </div>
  </div>
</div>   


<script>
  $(document).ready(function(){
    debugger
    var counter = 0;
    $('.user-select-check').on('click' , function(){
      if($(this).prop('checked')){
        counter += 1;
        $("#delete-users").show();
      } else {
        counter -= 1;
        if(counter <= 0) {
          $("#delete-users").hide();
        }
      }
    });

    $("#delete-users").on('click', function(){
      var userIds = [];
      $('.user-select-check').each(function(){
        if($(this).prop('checked')) {
          userIds.push($(this).data('user-id'))
          
        }
      });
      $.ajax({
        url: 'users/bulk_delete',
        type: 'DELETE',
        data: JSON.stringify({ user_ids: userIds }),  
        contentType: 'application/json', 
        dataType: 'json',
        
        success: function(response) {
          console.log("Response from server:", response); 
          if(response.deleted_user_ids && response.deleted_user_ids.length > 0) {
            response.deleted_user_ids.forEach(function(id) {
             
             $('#user-row-' + id).remove();
            });
          }
          

          counter = 0;
          $("#delete-users").hide();
        },
        error: function(xhr, status, error) {
          alert('An error occurred while deleting users: ' + error);
        }
      });
      
    });


  });

</script>
























